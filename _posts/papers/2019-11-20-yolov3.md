---
layout: post
title: YOLOv3：An Incremental Improvement
category: papers
tags: [Deep learning]
comments: true
---

# YOLOv3：An Incremental Improvement

Original paper: https://arxiv.org/abs/1804.02767

Authors: Joseph Redmon, Ali Farhadi

- 참고 글
  - https://www.youtube.com/watch?v=HMgcvgRrDcA
  - https://www.slideshare.net/JinwonLee9/pr207-yolov3-an-incremental-improvement

## Background
### IoU & mAP

<center>
<figure>
<img src="/assets/post_img/papers/2019-11-20-yolov3/fig1.PNG" alt="views">
<figcaption></figcaption>
</figure>
</center>

- mAP란?
  - Precision-Recall 그래프에서 빨간 선 기준으로 아래 면적이 Average Precision(AP)
    - Precision이 특정 값으로 fix 되었을 때의 recall값을 plot
      - Recall: 해당 precision을 기준으로 찾아진 정답의 rate
  - 각 클래스간 평균이 mean Average Precision, mAP가 됨

## Indroduction
- 본 논문은 일종의 tech report 개념
- YOLO의 성능을 개선시켰지만 super interesting한 결과는 아님
  - 작은 changes들을 모아서 성능을 개선시킨 정도
- 빠르진 않지만, 더 낫고 강력한 성능을 가짐
- 저자는 자기 트위터 끊었다고 더이상 태깅하지 마라...고 함

## Bounding Box Prediction
- YOLOv2와 동일
  - 미리 Anchor box 정의 후, regression을 통해 얼마나 움직일지에 대한 부분을 예측
- YOLOv3는 anchor box역할을 하는 dimension cluster들을 이용해 bounding box들을 예측함
- 네트워크는 4개의 box값을 예측하며, 각각 $t_x, t_y, t_w, t_h$로 x, y 위치와 width, height를 의미함

<center>
<figure>
<img src="/assets/post_img/papers/2019-11-20-yolov3/fig2.PNG" alt="views">
<figcaption></figcaption>
</figure>
</center>

- Box prediction은 추론된 rough한 박스 좌표를 정확한 GT값으로 맞춰주는 일종의 regression이므로 squared error loss를 사용함
  - $b_x=\rho(t_x)+c_x$
  - $b_y=\rho(t_y)+c_y$
    - $\rho$: Sigmoid function
    - 실제 움직여야 하는 값을 나타니는 $t_x, t_y$는 sigmoid에 의해 0~1사이의 값으로 매핑됨
    - 즉, bounding box의 중심은 다을 칸(다른 grid cell)로 벗어날 수 없음
  - $b_w=p_w e^{t_w}$
  - $b_h=p_h e^{t_h}$
    - Width와 height에 대한 term
    - $t_w, t_h$는 각각 width와 height로 얼만큼 움직여야하나를 의미
    - 원래 결과인 $p_w$와 $p_h$에 exponential term으로 곱해짐

- YOLOv3는 각 bounding box가 갖고있는 일종의 confidence인 objectness score를 이용해 객체의 위치를 탐지
  - Logistic regression을 통해 objectness score는 0~1사이 값을 갖게 됨
- GT와 가장 많이 겹치는 box prior의 objectness score는 1이 되도록 설정됨
  - 일반적인 SSD등의 방법에서 background class와 hard negative mining을 사용하는것과 다름
- YOLOv3는 각 GT에 대해 bounding box가 1개씩 할당됨
  - 이로인해 background class와 hard negative mining이 필요없음
    - 해당 알고리즘은 오탐되는경우에 대해 background class의 정보량이 너무 많아저 imbalance를 줄이고자 학습과정에서 적용되는 방법임
  - 다른 방법들은 GT와 IoU가 가장 큰 것 + IoU가 0.7(일반적으로)이상 되는 것 전부 다 box를 치게 됨
    - 정답이 아닌 경우 모두 background로 할당되로, 이로인해 background class의 정보량이 증가해 별도 처리(hard negative mining)를 하지 않으면 학습이 불가능하게 됨

## Class Prediction
- 다음으로 YOLOv3는 영상 내 찾아진 객체들의 위치에 대해 multilabel classification을 수행
  - 일반적으로 COCO 기준 80개 class를 할당해 softmax를 수행해 하나의 class를 찾음
  - 이 논문은 80개의 class별로 각각 확률을 sigmoid를 취해 binary classification을 수행함
    - 이로인해 multiclass classification이 되도록 함
- 왜 구지 multiclass classification?
  - Google openimage dataset과 같은 데이터셋을 위한 처리
    - 600개 클래스로 중복되는 상위-하위 클래스가 포함됨
  - Person의 경우 women처럼 hierarchical한 클래스들이 존재하는 경우, 여러 클래스를 동시에 고려해야하므로 binary classification이 적용됨

## Predictions Across Scales
- 3가지 scale에 대해 3개의 bounding box(aspect ratio)를 사용함
  - 3x3으로 총 9개의 bounding box들을 추론
  - Scale에 따라 resolution이 바뀌므로 정확하게 9개라고 보기에는 조금 애매함
- 이 때 찾아진 tensor size는 $N\times N\times(3\times(4+1+80))$
  - $N\times N$: NxN개의 grid cell들
  - 3: 3개의 scale에서 bounding box 찾기
  - 4: x, y, w, h
  - 1: objectness score
  - 80: MS COCO classes score

<center>
<figure>
<img src="/assets/post_img/papers/2019-11-20-yolov3/fig3.PNG" alt="views">
<figcaption></figcaption>
</figure>
</center>

- 위 그림에서 grid cell이 총 NxN개가 존재한다고 하면(개 사진)
  - 빨간색으로 칠해진 해당 grid cell에서 해당 scale에서의 aspect ratio로 정의된 크기의 anchor box 3개를 뽑게 됨
  - Depth 방향으로 (4+1+80)x3 으로 총 255의 depth가 쌓임

## Anchor Boxes
- 기존의 방법(SSD나 RCNN)들은 정해진 aspect ratio 사용
  - k-means clustering으로 얻어진 aspect ratio를 이용해 해당 비율을 갖는 객체만 찾게 됨
- YOLO는 갖고있는 training set을 분석해서 anchor box의 aspect ratio를 정함
- MS COCO기준 scale별로 총 9개의 cluster를 정함
  - Small: 10x13, 16x30, 33x23
  - Medium: 30x61, 62x45, 59x119
  - Large: 116x90, 156x198, 373x326

## Number of Bounding boxes
- YOLOv1: 98 boxes (7x7 cells, 2 boxes per cell @448x448)
- YOLOv2: 845 boxes (13x13 cells, 5 anchor boxes @416x416)
- YOLOv3: 10,647 boxes (@416x416)

- YOLOv3는 10배정도 많은 box들을 사용함
  - 1-stage 성능 높히기 위해선 피할 수 없는 선택!
