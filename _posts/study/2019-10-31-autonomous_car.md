---
layout: post
title: 자율주행차 만들기
category: study
tags: [자율주행, Autonomous driving]
comments: true
---

# 자율 주행 자동차 만들기
## 1. 자율 주행 개요
### 자율 주행 알고리즘
#### 센싱
- GPS와 IMU(Inertial measurement unit)
  - 자율 주행차의 위치 파악을 위해 필요함
  - 관성정보 및 지리적 위치에 대한 측정 값을 200Hz 이상의 빠른 주기로 알려줌
  - GPS는 로컬라이제이션 센서 중 상당히 정확하지만 업데이트 주기가 약 10Hz 수준으로 긴 편
  - 따라서 최신 위치 정보를 실시간 제공받을 수 없음
  - IMU는 시간 흐름에 따른 누적 오차로 인해 위치 추정 값의 정확도가 갈수록 떨어짐
  - 하지만 IMU는 주기가 200Hz 이상으로 굉장히 짧아 실시간성이 좋음
  - 따라서 GPS와 IMU를 조합하여 차량 위치에 대한 정확한 정보를 실시간으로 업데이트함
- 라이다
  - 매핑, 로컬라이제이션, 장애물 회피등에 사용됨
  - 레이저 빛의 ToF를 측정해 거리를 측정하고 단색 3D 맵을 생성
  - 정확도가 높기 때문에 HD맵을 생성하고 이동중인 자동차 위치를 파악해 로컬라이제이션(추정)한 뒤, 전방의 장애물을 감지하는 작업에 주로 사용됨
    - 벨로다인 64빔 레이저는 10Hz 주기로 회전하며 측정값을 초당 130만번 읽음
- 카메라
  - 차로, 신호등, 보행자 감지 등과 같이 객체 인지 및 추적 작업에 활용됨
  - 현재는 안전성을 높이기 위해 1080p 카메라를 8개 이상 사용함
  - 이를 토대로 전방, 후방, 좌우 객체를 감지하고 인지하고 추적함
  - 초당 약 1.8GB에 해당하는 원본 데이터를 생성함
- 레이더와 소나
- 장애물 회피를 위한 최후의 수단으로 사용됨
- 차량 이동 경로 선상에서 가장 가까이 있는 대상까지의 거리와 속도 정보를 담고있음
- 레이더와 소나에서 생성된 데이터는 가공을 잘 하지 않음
- 또한 메인 연산 파이프라인을 거치지 않고 제어 장치로 곧바로 전달해 방향을 전환하거나 브레이크를 밟거나 안전벨트를 당기는 __긴급한 동작 수행__
#### 인지
- 로컬라이제이션, 객체 감지, 객체 추적의 3단계로 구성
##### 로컬라이제이션
  - GPS/IMU를 활용해 현재 위치를 계산
  - GPS의 느린 주기와 높은 정확도, IMU의 빠른 주기와 큰 누적 오차의 장점들을 잘 융합하도록 __칼만 필터__ 를 사용함
    - IMU는 5ms마다 차랑의 최신 위치 정보를 알려주지만 시간이 갈수록 오차가 누적됨
    - 이런 IMU의 오차를 100ms마다 GPS 정보로 보정함
  - GPS와 IMU를 조합한 장치로 전파 업데이트 모델을 구현함으로써 로컬라이제이션 결과를 빠르고 정확하게 계산
  
<center>
<figure>
<img src="/assets/post_img/study/2019-10-31-autonomous_car/fig1.JPG" alt="views">
<figcaption></figcaption>
</figure>
</center>

- 하지만, GPS와 IMU만을 이용해 조합한 결과를 완전히 믿을 순 없음
  - 정확도는 1미터 범위에서만 보장됨
  - GPS신호는 다중 경로 문제를 갖고 있기 때문에 신호가 건물에 반사되며 노이즈가 증가
  - 하늘이 가려진 곳에서는 GPS신호를 정확히 수신 불가
- 카메라를 이용해 비전 기반으로 로컬라이제이션 파이프라인을 구성하면 다음과 같음
  - 스테레오 이미지 쌍에 대한 삼각 측량으로 disparity map 만들기
    - 각 포인트의 깊이 정보를 추출하는데 활용됨
  - 연속적으로 들어오는 스테레오 이미지 프레임 사이에서 두드러진 특징을 찾아 각 각 특징점 사이의 상호 연관 관계 파악
  - 특징점과 기존에 파악한 맵을 비교하는 방식으로 차량의 현재 위치를 알아 낼 수 있음
  - 하지만 비전 기반의 위치 측정 기법은 조명 상태에 민감하기에 이 방법만으론 구현 불가
  - 파이프라인
    - 스테레오 이미지로 삼각측량->특징감지->특징매칭->동작예측->차량위치
      - 중간에 이전 시차 맵을 사용
- __위와 같은 이유들로 인해 라이다 기반 시스템의 particle filter 기법을 주로 사용함__
  - 라이다로 생성된 포인트 클라우드로 주변 환경에 대한 형태를 만들고
  - 파티클 필터를 이용해 관측된 형태를 기존에 파악된 맵과 비교하는 방식으로 불확실성을 줄임
    - 파티클 필터를 적용해 라이다 측정 값과 맵의 상호 연관성을 파악하는 방식으로 이동 중인 차량의 로컬라이제이션을 처리함
    - 파티클 필터 기법은 10cm 수준의 정확도로 로컬라이제이션을 실시간으로 처리 할 수 있으며 도시 환경에서 효과적임
  - 하지만 라이다 자체도 주변 대기 환경(비, 안개 등)에 민감하게 반응하므로 신뢰성을 높히기 위해 __센서 퓨전__ 프로세스를 적용함
- __센서 퓨전은 각 센서가 갖는 장점 특성을 융합해 취합하는 프로세스__

<center>
<figure>
<img src="/assets/post_img/study/2019-10-31-autonomous_car/fig2.JPG" alt="views">
<figcaption></figcaption>
</figure>
</center>

##### 객체 인지 및 추적
- 주로 라이다나 CNN 기반의 영상처리를 이용해 객체 인지 작업 수행
  - 영상 속에 어떤 객체가 어느 크기로 어느 위치에 존재하는지를 찾는 작업
- 객체 추적이란 원하는 객체를 선택해서 해당 객체의 이동 궤적을 자동으로 추정하는 기법
  - 주변의 자동차나 보행자 등을 추적하는데 이 기법을 적용해 충돌 방지에 활용함

##### 동작
- 차량의 주변 환경을 파악했다면 의사결정 단계에서 안전하고 효율적인 동작 계획을 실시간으로 생성
- 동작 예측
  - 안전한 운행을 위해선 동작 예측이 필수임
  - 다른 차량의 도달 가능한 지점에 대한 확률 모델을 만들고, 도달 가능한 지점에 대한 확률 분포를 구하는 기법이 있음
- 경로 계획
  - 일반적으로 가능한 모든 경로를 탐색하고 비용함수로 최적의 경로를 선택하면 된다고 생각하지만, 이는 엄청난 연산량이 필요하며 실시간 처리가 불가
  - 이처럼 __결정적인 알고리즘을 적용할 때엔 계산 복잡도를 줄여 실시간 처리를 위해 확률 기반의 기법을 주로 사용함__
- 장애물 회피
  - 물체와 부딪히지 않도록 장애물 회피 메커니즘을 두 단계 이상으로 구성함
  - 첫 번째는 등동형 메커니즘으로, 교통 예측을 기반으로 처리
    - 차량이 주행하는 동안 교통 예측을 통해 충돌까지 남은 시간이나 최소 거리에 대한 추정치 등을 계산하며, 이 정보를 토대로 장애물 회피 메커니즘이 작동해 주변 경로를 다시 계획
  - 두 번째는 레이더 데이터 기반의 수동형(반응형) 메커니즘으로, 경로 상의 물체가 감지되면 주행 제어 시스템에 개입해 장애물을 피하도록 조작
  
### 자율 주행 클라이언트 시스템
- 실시간 및 신뢰성 요구사항을 만족하도록 앞의 알고리즘을 통합함
  - 데이터량이 많으므로 방대한 양의 데이터가 충분히 처리 가능할 정도의 프로세싱 파이프라인이 빨라야 하고
  - 한 부분에서 오류가 발생하더라도 복구 가능할 정도로 견고해야 함
  - 이 연산을 처리함에 있어 에너지 및 리소스 제약사항도 만족해야 함

#### ROS
- 각 작업을 수행하는 노드를 만들고, 이를 연결하여 전체 시스템을 구성
  - 각 노드는 토픽, 서비스를 통해 서로 통신함
- 문제점
  - 신뢰성: 마스터는 하나만 존재하고 장애가 발생한 노드를 복구하기 위한 모니터가 없음
  - 성능: 메시지를 브로드캐스트 방식으로 보내는 과정에서 같은 메시지가 여러 번 중복되어 성능저하 유발
  - 보안: 인증과 암호화 메커니즘이 없음 (ROS2.0에서 보완)
- 신뢰성
  - 마스터 노드가 하나기때문에 마스터 노드가 죽으면 전체 시스템이 죽음
    - 이를 해결하기 위해 백업 마스터 노드를 설정
    - 메인 노드가 죽으면 백업 노드가 이어받아 시스템이 그대로 구동되게 함
    - 또한 주키퍼 메커니즘을 통해 모니터링하다가 장애가 발생한 노드 발견 시 이를 재구동해 전체 ROS 시스템의 신뢰성을 보장
- 성능
  - 공유 메모리 메커니즘을 적용해 메시지가 TCP/IP 스택을 거치지 않고 목적지 노드로 곧바로 가도록 처리
  - ROS 노드가 메시지를 브로드캐스팅하는 과정에서 여러 개의 복사본을 만들어 느려짐
    - 멀티캐스트 메커니즘으로 대체하여 시스템 처리량을 향상시켜 보완 가능
- 보안
  - 해커가 ROS 노드에 침투해 메모리를 끊임없이 할당시켜 전체 메모리를 고갈시켜 시스템을 뻗게 할 수 있음
    - 리눅스 컨테이너를 사용해 각 노드마다 허용된 리소스 양을 제한하는 방식으로 해결 가능
  - ROS 노드끼리 주고받는 메시지를 중간에 가로채는 중간자 공격에 취약
    - 통신 과정에서 메시지를 암호화 시켜서 해결 가능

#### 하드웨어 플랫폼
- 책 저자는 ARM SoC를 이용해 최대 전력소비량이 15W에 불과한 시스템을 이용함
  - 25FPS로 로컬라이제이션 수행 가능
  - 3FPS로 객체탐지
  - 6ms로 계획 및 제어 파이프라인 구동
  - 시스템을 차량에 장착해 로컬라이제이션 과정에 손실 없이 시속 8km/h로 구동
    
